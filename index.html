<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatHub - 简洁聊天平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --gray-color: #adb5bd;
            --border-radius: 12px;
            --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .auth-box {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .auth-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }
        
        .auth-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        
        .auth-footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-footer a:hover {
            text-decoration: underline;
        }
        
        /* 主界面样式 */
        .main-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo i {
            font-size: 2.2rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: white;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-width: 200px;
            padding: 0.5rem 0;
            margin-top: 10px;
            display: none;
            z-index: 1000;
        }
        
        .user-dropdown.active {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-color);
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item i {
            width: 20px;
            color: var(--gray-color);
        }
        
        .container {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 1.5rem;
            gap: 1.5rem;
        }
        
        .sidebar {
            width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: fit-content;
            position: sticky;
            top: 6.5rem;
        }
        
        .sidebar-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .sidebar-tab {
            flex: 1;
            text-align: center;
            padding: 0.8rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-color);
            transition: all 0.3s;
        }
        
        .sidebar-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border: 1px solid #e9ecef;
            border-radius: 30px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        .contacts-list, .friends-list, .add-friend-list {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
        }
        
        .contact, .friend-item, .add-friend-item {
            display: flex;
            align-items: center;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .contact:hover, .friend-item:hover, .add-friend-item:hover {
            background-color: #f8f9fa;
        }
        
        .contact.active {
            background-color: rgba(67, 97, 238, 0.1);
            border-left: 4px solid var(--primary-color);
        }
        
        .contact-avatar, .friend-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .contact-info, .friend-info {
            flex: 1;
        }
        
        .contact-info h4, .friend-info h4 {
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .contact-info p, .friend-info p {
            font-size: 0.85rem;
            color: var(--gray-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px;
        }
        
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        
        .friend-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background-color: #f0f2f5;
            color: var(--gray-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .friend-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .add-friend-btn {
            padding: 6px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-friend-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .add-friend-btn.pending {
            background-color: #ffc107;
            color: #212529;
        }
        
        .add-friend-btn.pending:hover {
            background-color: #e0a800;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-user h3 {
            font-size: 1.3rem;
        }
        
        .status {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--gray-color);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .online {
            background-color: #4ade80;
        }
        
        .offline {
            background-color: #ef4444;
        }
        
        .chat-actions {
            display: flex;
            gap: 15px;
        }
        
        .chat-actions button {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--gray-color);
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .chat-actions button:hover {
            color: var(--primary-color);
        }
        
        .messages-container {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            display: flex;
            align-items: flex-end;
            max-width: 70%;
            gap: 10px;
        }
        
        .message.received {
            align-self: flex-start;
        }
        
        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .message-content {
            padding: 14px 18px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .message.received .message-content {
            background-color: white;
            border-top-left-radius: 4px;
        }
        
        .message.sent .message-content {
            background-color: var(--primary-color);
            color: white;
            border-top-right-radius: 4px;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--gray-color);
            margin-top: 6px;
            text-align: right;
        }
        
        .message.received .message-time {
            text-align: left;
        }
        
        .message-input-area {
            padding: 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .message-input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid #e9ecef;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s;
            resize: none;
            max-height: 120px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .send-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }
        
        .friends-panel {
            width: 280px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 6.5rem;
        }
        
        .friends-panel h3 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .friend-requests {
            margin-bottom: 2rem;
        }
        
        .friend-request-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        
        .friend-request-info {
            flex: 1;
        }
        
        .friend-request-info h4 {
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .friend-request-info p {
            font-size: 0.85rem;
            color: var(--gray-color);
        }
        
        .friend-request-actions {
            display: flex;
            gap: 8px;
        }
        
        .accept-btn, .reject-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .accept-btn {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
        }
        
        .accept-btn:hover {
            background-color: var(--success-color);
            color: white;
        }
        
        .reject-btn {
            background-color: rgba(247, 37, 133, 0.2);
            color: var(--warning-color);
        }
        
        .reject-btn:hover {
            background-color: var(--warning-color);
            color: white;
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            right: 100px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            width: 300px;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            z-index: 100;
        }
        
        .emoji-picker.show {
            display: grid;
        }
        
        .emoji {
            font-size: 1.5rem;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .emoji:hover {
            background-color: #f0f2f5;
        }
        
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s;
            z-index: 1000;
            max-width: 320px;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .no-contacts, .no-friends, .no-users {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-color);
        }
        
        .no-contacts i, .no-friends i, .no-users i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #e9ecef;
        }
        
        .add-friend-search {
            margin-bottom: 1.5rem;
        }
        
        @media (max-width: 1100px) {
            .container {
                flex-wrap: wrap;
            }
            
            .sidebar, .friends-panel {
                width: 100%;
                position: static;
            }
            
            .chat-area {
                order: 2;
                width: 100%;
            }
            
            .contacts-list, .friends-list, .add-friend-list {
                max-height: 300px;
            }
        }
        
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .logo span {
                display: none;
            }
            
            .user-name {
                display: none;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- 登录/注册界面 -->
    <div class="auth-container" id="auth-container">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" id="login-tab">登录</div>
                <div class="auth-tab" id="register-tab">注册</div>
            </div>
            
            <form class="auth-form active" id="login-form">
                <div class="form-group">
                    <label for="login-username">用户名</label>
                    <input type="text" id="login-username" placeholder="请输入用户名" required>
                </div>
                
                <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" placeholder="请输入密码" required>
                </div>
                
                <button type="submit" class="auth-btn">登录</button>
                
                <div class="auth-footer">
                    <p>还没有账号？ <a href="#" id="go-to-register">立即注册</a></p>
                </div>
            </form>
            
            <form class="auth-form" id="register-form">
                <div class="form-group">
                    <label for="register-username">用户名</label>
                    <input type="text" id="register-username" placeholder="请输入用户名" required>
                </div>
                
                <div class="form-group">
                    <label for="register-email">邮箱</label>
                    <input type="email" id="register-email" placeholder="请输入邮箱" required>
                </div>
                
                <div class="form-group">
                    <label for="register-password">密码</label>
                    <input type="password" id="register-password" placeholder="请输入密码" required>
                </div>
                
                <div class="form-group">
                    <label for="register-confirm-password">确认密码</label>
                    <input type="password" id="register-confirm-password" placeholder="请再次输入密码" required>
                </div>
                
                <button type="submit" class="auth-btn">注册</button>
                
                <div class="auth-footer">
                    <p>已有账号？ <a href="#" id="go-to-login">立即登录</a></p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 主界面 -->
    <div class="main-container" id="main-container">
        <header>
            <div class="logo">
                <i class="fas fa-comment-dots"></i>
                <span>ChatHub</span>
            </div>
            <div class="user-info">
                <div class="user-menu">
                    <button class="user-menu-btn" id="user-menu-btn">
                        <div class="avatar" id="user-avatar">U</div>
                        <span class="user-name" id="user-name">用户</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <a href="#" class="dropdown-item" id="profile-btn">
                            <i class="fas fa-user"></i>
                            <span>个人资料</span>
                        </a>
                        <a href="#" class="dropdown-item" id="friends-btn">
                            <i class="fas fa-users"></i>
                            <span>好友管理</span>
                        </a>
                        <a href="#" class="dropdown-item" id="settings-btn">
                            <i class="fas fa-cog"></i>
                            <span>设置</span>
                        </a>
                        <div class="dropdown-item" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container">
            <div class="sidebar">
                <div class="sidebar-tabs">
                    <div class="sidebar-tab active" id="chats-tab">聊天</div>
                    <div class="sidebar-tab" id="friends-tab">好友</div>
                    <div class="sidebar-tab" id="add-friend-tab">添加好友</div>
                </div>
                
                <!-- 聊天列表 -->
                <div class="sidebar-content">
                    <div class="search-box" id="chats-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-chats" placeholder="搜索聊天...">
                    </div>
                    
                    <div class="contacts-list" id="contacts-list">
                        <!-- 聊天列表将通过JavaScript动态生成 -->
                    </div>
                    
                    <div class="friends-list" id="friends-list" style="display: none;">
                        <!-- 好友列表将通过JavaScript动态生成 -->
                    </div>
                    
                    <div class="add-friend-list" id="add-friend-list" style="display: none;">
                        <div class="add-friend-search">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="search-users" placeholder="搜索用户...">
                            </div>
                        </div>
                        
                        <div id="users-list">
                            <!-- 用户列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-user">
                        <div class="contact-avatar" id="current-chat-avatar" style="background-color: #e9ecef; color: #333;">?</div>
                        <div>
                            <h3 id="current-chat-user">选择聊天</h3>
                            <div class="status">
                                <div class="status-dot offline" id="current-chat-status"></div>
                                <span id="current-chat-status-text">离线</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button id="video-call-btn" title="视频通话" disabled><i class="fas fa-video"></i></button>
                        <button id="voice-call-btn" title="语音通话" disabled><i class="fas fa-phone"></i></button>
                        <button id="emoji-btn" title="表情符号" disabled><i class="far fa-smile"></i></button>
                    </div>
                </div>
                
                <div class="messages-container" id="messages-container">
                    <div class="no-contacts">
                        <i class="fas fa-comments"></i>
                        <h3>欢迎使用 ChatHub</h3>
                        <p>选择左侧的联系人开始聊天，或添加新好友</p>
                    </div>
                </div>
                
                <div class="message-input-area">
                    <button id="attach-btn" title="附加文件" disabled><i class="fas fa-paperclip"></i></button>
                    <textarea class="message-input" id="message-input" placeholder="选择聊天后输入消息...按Enter发送，Shift+Enter换行" rows="1" disabled></textarea>
                    <button class="send-btn" id="send-btn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <div class="friends-panel">
                <h3><i class="fas fa-user-friends"></i> 好友与请求</h3>
                
                <div class="friend-requests" id="friend-requests">
                    <h4>好友请求</h4>
                    <!-- 好友请求将通过JavaScript动态生成 -->
                </div>
                
                <div class="friends-online">
                    <h4>在线好友 <span id="online-count">0</span></h4>
                    <!-- 在线好友列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <div class="notification" id="notification">
            <div class="notification-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div>
                <h4 id="notification-title">新消息</h4>
                <p id="notification-text">您收到了一条新消息</p>
            </div>
        </div>
    </div>

    <script>
        // 用户数据库 - 完全空，没有任何预设用户
        let usersDB = JSON.parse(localStorage.getItem('chathub_users')) || [];
        
        // 好友关系数据库 - 初始为空
        let friendsDB = JSON.parse(localStorage.getItem('chathub_friends')) || [];
        
        // 好友请求数据库 - 初始为空
        let friendRequestsDB = JSON.parse(localStorage.getItem('chathub_friend_requests')) || [];
        
        // 消息数据库 - 初始为空
        let messagesDB = JSON.parse(localStorage.getItem('chathub_messages')) || {};
        
        // 在线状态数据库 - 初始为空
        let onlineStatus = JSON.parse(localStorage.getItem('chathub_online_status')) || {};
        
        // 当前登录用户
        let currentUser = null;
        
        // 当前选中的聊天用户ID
        let currentChatUserId = null;
        
        // DOM元素
        const authContainer = document.getElementById('auth-container');
        const mainContainer = document.getElementById('main-container');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const goToRegister = document.getElementById('go-to-register');
        const goToLogin = document.getElementById('go-to-login');
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const chatsTab = document.getElementById('chats-tab');
        const friendsTab = document.getElementById('friends-tab');
        const addFriendTab = document.getElementById('add-friend-tab');
        const contactsList = document.getElementById('contacts-list');
        const friendsList = document.getElementById('friends-list');
        const addFriendList = document.getElementById('add-friend-list');
        const usersList = document.getElementById('users-list');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const currentChatUser = document.getElementById('current-chat-user');
        const currentChatAvatar = document.getElementById('current-chat-avatar');
        const currentChatStatus = document.getElementById('current-chat-status');
        const currentChatStatusText = document.getElementById('current-chat-status-text');
        const friendRequestsContainer = document.getElementById('friend-requests');
        const onlineCount = document.getElementById('online-count');
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notification-title');
        const notificationText = document.getElementById('notification-text');
        const searchUsersInput = document.getElementById('search-users');
        const emojiBtn = document.getElementById('emoji-btn');
        const videoCallBtn = document.getElementById('video-call-btn');
        const voiceCallBtn = document.getElementById('voice-call-btn');
        const attachBtn = document.getElementById('attach-btn');
        
        // 初始化
        function init() {
            // 检查是否有用户已登录
            const loggedInUser = JSON.parse(localStorage.getItem('chathub_current_user'));
            if (loggedInUser) {
                currentUser = loggedInUser;
                showMainApp();
            }
            
            // 初始化事件监听器
            initEventListeners();
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 登录/注册标签切换
            loginTab.addEventListener('click', () => switchAuthTab('login'));
            registerTab.addEventListener('click', () => switchAuthTab('register'));
            goToRegister.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('register');
            });
            goToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });
            
            // 登录表单提交
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin();
            });
            
            // 注册表单提交
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleRegister();
            });
            
            // 用户菜单
            userMenuBtn.addEventListener('click', toggleUserDropdown);
            
            // 退出登录
            logoutBtn.addEventListener('click', handleLogout);
            
            // 点击其他地方关闭用户菜单
            document.addEventListener('click', (e) => {
                if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
            
            // 侧边栏标签切换
            chatsTab.addEventListener('click', () => switchSidebarTab('chats'));
            friendsTab.addEventListener('click', () => switchSidebarTab('friends'));
            addFriendTab.addEventListener('click', () => switchSidebarTab('add-friend'));
            
            // 发送消息
            sendBtn.addEventListener('click', sendMessage);
            
            // 消息输入框事件
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                
                // 自动调整文本区域高度
                setTimeout(() => {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = (messageInput.scrollHeight) + 'px';
                }, 0);
            });
            
            // 搜索用户
            searchUsersInput.addEventListener('input', handleUserSearch);
            
            // 禁用表情按钮
            emojiBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('功能提示', '选择好友开始聊天后可使用表情功能');
            });
            
            // 禁用通话按钮
            videoCallBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('功能提示', '选择好友开始聊天后可使用视频通话功能');
            });
            
            voiceCallBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('功能提示', '选择好友开始聊天后可使用语音通话功能');
            });
            
            // 禁用附件按钮
            attachBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('功能提示', '选择好友开始聊天后可使用文件发送功能');
            });
            
            // 个人资料按钮
            document.getElementById('profile-btn').addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('个人资料', '个人资料功能开发中');
            });
            
            // 好友管理按钮
            document.getElementById('friends-btn').addEventListener('click', (e) => {
                e.preventDefault();
                switchSidebarTab('friends');
            });
            
            // 设置按钮
            document.getElementById('settings-btn').addEventListener('click', (e) => {
                e.preventDefault();
                showNotification('设置', '设置功能开发中');
            });
        }
        
        // 切换登录/注册标签
        function switchAuthTab(tab) {
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
            }
        }
        
        // 处理登录
        function handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            // 验证用户
            const user = usersDB.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('chathub_current_user', JSON.stringify(user));
                
                // 更新登录用户的在线状态
                onlineStatus[user.id] = true;
                localStorage.setItem('chathub_online_status', JSON.stringify(onlineStatus));
                
                showMainApp();
                showNotification('登录成功', `欢迎回来，${user.username}！`);
            } else {
                showNotification('登录失败', '用户名或密码错误');
            }
        }
        
        // 处理注册
        function handleRegister() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            // 验证输入
            if (!username || !email || !password) {
                showNotification('注册失败', '请填写所有必填字段');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('注册失败', '两次输入的密码不一致');
                return;
            }
            
            if (username.length < 3) {
                showNotification('注册失败', '用户名至少需要3个字符');
                return;
            }
            
            if (password.length < 6) {
                showNotification('注册失败', '密码至少需要6个字符');
                return;
            }
            
            if (usersDB.find(u => u.username === username)) {
                showNotification('注册失败', '用户名已存在');
                return;
            }
            
            if (usersDB.find(u => u.email === email)) {
                showNotification('注册失败', '邮箱已被注册');
                return;
            }
            
            // 创建新用户
            const newUser = {
                id: usersDB.length > 0 ? Math.max(...usersDB.map(u => u.id)) + 1 : 1,
                username,
                email,
                password,
                avatar: username.charAt(0).toUpperCase(),
                color: getRandomColor(),
                createdAt: new Date().toISOString()
            };
            
            usersDB.push(newUser);
            localStorage.setItem('chathub_users', JSON.stringify(usersDB));
            
            // 初始化新用户的在线状态
            onlineStatus[newUser.id] = true;
            localStorage.setItem('chathub_online_status', JSON.stringify(onlineStatus));
            
            // 自动登录
            currentUser = newUser;
            localStorage.setItem('chathub_current_user', JSON.stringify(newUser));
            showMainApp();
            showNotification('注册成功', `欢迎加入ChatHub，${username}！`);
            
            // 清空表单
            document.getElementById('register-form').reset();
        }
        
        // 显示主应用界面
        function showMainApp() {
            authContainer.style.display = 'none';
            mainContainer.style.display = 'flex';
            
            // 更新用户信息
            updateUserInfo();
            
            // 渲染所有数据
            renderChatsList();
            renderFriendsList();
            renderAddFriendList();
            renderFriendRequests();
            updateOnlineCount();
        }
        
        // 更新用户信息
        function updateUserInfo() {
            if (currentUser) {
                userAvatar.textContent = currentUser.avatar;
                userAvatar.style.backgroundColor = currentUser.color;
                userName.textContent = currentUser.username;
            }
        }
        
        // 切换侧边栏标签
        function switchSidebarTab(tab) {
            // 更新标签状态
            chatsTab.classList.remove('active');
            friendsTab.classList.remove('active');
            addFriendTab.classList.remove('active');
            
            // 隐藏所有内容
            contactsList.style.display = 'none';
            friendsList.style.display = 'none';
            addFriendList.style.display = 'none';
            document.getElementById('chats-search').style.display = 'none';
            
            // 显示选中的内容
            if (tab === 'chats') {
                chatsTab.classList.add('active');
                contactsList.style.display = 'block';
                document.getElementById('chats-search').style.display = 'block';
            } else if (tab === 'friends') {
                friendsTab.classList.add('active');
                friendsList.style.display = 'block';
            } else {
                addFriendTab.classList.add('active');
                addFriendList.style.display = 'block';
            }
        }
        
        // 渲染聊天列表
        function renderChatsList() {
            if (!currentUser) return;
            
            contactsList.innerHTML = '';
            
            // 获取用户的好友
            const friends = getFriends();
            
            if (friends.length === 0) {
                contactsList.innerHTML = `
                    <div class="no-contacts">
                        <i class="fas fa-user-plus"></i>
                        <h3>暂无聊天</h3>
                        <p>添加好友后开始聊天</p>
                    </div>
                `;
                return;
            }
            
            friends.forEach(friend => {
                const user = getUserById(friend.friendId);
                if (!user) return;
                
                // 获取最后一条消息
                const lastMessage = getLastMessageWithUser(friend.friendId);
                
                const contactElement = document.createElement('div');
                contactElement.className = `contact ${friend.friendId === currentChatUserId ? 'active' : ''}`;
                contactElement.innerHTML = `
                    <div class="contact-avatar" style="background-color: ${user.color};">${user.avatar}</div>
                    <div class="contact-info">
                        <h4>${user.username}</h4>
                        <p>${lastMessage ? lastMessage.text : '暂无消息'}</p>
                    </div>
                    <div style="margin-left: auto; font-size: 0.8rem; color: var(--gray-color);">
                        ${lastMessage ? lastMessage.time : ''}
                    </div>
                `;
                
                contactElement.addEventListener('click', () => {
                    // 移除所有联系人的active类
                    document.querySelectorAll('.contact').forEach(c => c.classList.remove('active'));
                    // 为当前联系人添加active类
                    contactElement.classList.add('active');
                    // 切换到当前联系人
                    switchChat(friend.friendId);
                });
                
                contactsList.appendChild(contactElement);
            });
        }
        
        // 渲染好友列表
        function renderFriendsList() {
            if (!currentUser) return;
            
            friendsList.innerHTML = '';
            
            // 获取用户的好友
            const friends = getFriends();
            
            if (friends.length === 0) {
                friendsList.innerHTML = `
                    <div class="no-friends">
                        <i class="fas fa-user-friends"></i>
                        <h3>暂无好友</h3>
                        <p>去添加好友吧</p>
                    </div>
                `;
                return;
            }
            
            friends.forEach(friend => {
                const user = getUserById(friend.friendId);
                if (!user) return;
                
                const friendElement = document.createElement('div');
                friendElement.className = 'friend-item';
                friendElement.innerHTML = `
                    <div class="friend-avatar" style="background-color: ${user.color};">${user.avatar}</div>
                    <div class="friend-info">
                        <h4>${user.username}</h4>
                        <p>${onlineStatus[user.id] ? '在线' : '离线'}</p>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-btn" title="发送消息" data-user-id="${user.id}">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="friend-btn" title="删除好友" data-user-id="${user.id}">
                            <i class="fas fa-user-minus"></i>
                        </button>
                    </div>
                `;
                
                friendsList.appendChild(friendElement);
            });
            
            // 为好友按钮添加事件监听器
            document.querySelectorAll('.friend-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = btn.getAttribute('data-user-id');
                    if (btn.querySelector('.fa-comment')) {
                        // 发送消息
                        switchChat(parseInt(userId));
                        switchSidebarTab('chats');
                    } else if (btn.querySelector('.fa-user-minus')) {
                        // 删除好友
                        removeFriend(parseInt(userId));
                    }
                });
            });
        }
        
        // 渲染添加好友列表
        function renderAddFriendList() {
            if (!currentUser) return;
            
            usersList.innerHTML = '';
            
            // 获取不是好友的用户
            const nonFriends = usersDB.filter(user => 
                user.id !== currentUser.id && 
                !getFriends().some(friend => friend.friendId === user.id)
            );
            
            if (nonFriends.length === 0) {
                usersList.innerHTML = `
                    <div class="no-users">
                        <i class="fas fa-users"></i>
                        <h3>暂无更多用户</h3>
                        <p>所有用户都已经是您的好友，或者系统暂无其他用户</p>
                    </div>
                `;
                return;
            }
            
            nonFriends.forEach(user => {
                // 检查是否有待处理的好友请求
                const hasPendingRequest = friendRequestsDB.some(req => 
                    (req.fromUserId === currentUser.id && req.toUserId === user.id && req.status === 'pending') ||
                    (req.fromUserId === user.id && req.toUserId === currentUser.id && req.status === 'pending')
                );
                
                const userElement = document.createElement('div');
                userElement.className = 'add-friend-item';
                userElement.innerHTML = `
                    <div class="contact-avatar" style="background-color: ${user.color};">${user.avatar}</div>
                    <div class="contact-info">
                        <h4>${user.username}</h4>
                        <p>${user.email}</p>
                    </div>
                    <button class="add-friend-btn ${hasPendingRequest ? 'pending' : ''}" data-user-id="${user.id}">
                        ${hasPendingRequest ? '请求已发送' : '添加好友'}
                    </button>
                `;
                
                usersList.appendChild(userElement);
            });
            
            // 为添加好友按钮添加事件监听器
            document.querySelectorAll('.add-friend-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const userId = parseInt(btn.getAttribute('data-user-id'));
                    sendFriendRequest(userId);
                });
            });
        }
        
        // 渲染好友请求
        function renderFriendRequests() {
            if (!currentUser) return;
            
            // 获取发送给当前用户的好友请求
            const requests = friendRequestsDB.filter(req => 
                req.toUserId === currentUser.id && req.status === 'pending'
            );
            
            friendRequestsContainer.innerHTML = '';
            
            if (requests.length === 0) {
                friendRequestsContainer.innerHTML = '<h4>好友请求</h4><p style="color: var(--gray-color); font-size: 0.9rem;">暂无好友请求</p>';
                return;
            }
            
            const requestsHeader = document.createElement('h4');
            requestsHeader.textContent = `好友请求 (${requests.length})`;
            friendRequestsContainer.appendChild(requestsHeader);
            
            requests.forEach(request => {
                const user = getUserById(request.fromUserId);
                if (!user) return;
                
                const requestElement = document.createElement('div');
                requestElement.className = 'friend-request-item';
                requestElement.innerHTML = `
                    <div class="contact-avatar" style="background-color: ${user.color};">${user.avatar}</div>
                    <div class="friend-request-info">
                        <h4>${user.username}</h4>
                        <p>想添加您为好友</p>
                    </div>
                    <div class="friend-request-actions">
                        <button class="accept-btn" data-request-id="${request.id}">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="reject-btn" data-request-id="${request.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                friendRequestsContainer.appendChild(requestElement);
            });
            
            // 为接受/拒绝按钮添加事件监听器
            document.querySelectorAll('.accept-btn, .reject-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const requestId = parseInt(btn.getAttribute('data-request-id'));
                    if (btn.classList.contains('accept-btn')) {
                        acceptFriendRequest(requestId);
                    } else {
                        rejectFriendRequest(requestId);
                    }
                });
            });
        }
        
        // 更新在线好友数量
        function updateOnlineCount() {
            if (!currentUser) return;
            
            const friends = getFriends();
            const onlineFriends = friends.filter(friend => onlineStatus[friend.friendId]);
            
            onlineCount.textContent = onlineFriends.length;
        }
        
        // 切换到与指定用户的聊天
        function switchChat(userId) {
            currentChatUserId = userId;
            const user = getUserById(userId);
            
            if (!user) return;
            
            // 更新当前聊天用户信息
            currentChatUser.textContent = user.username;
            currentChatAvatar.textContent = user.avatar;
            currentChatAvatar.style.backgroundColor = user.color;
            
            // 更新在线状态
            const isOnline = onlineStatus[user.id];
            currentChatStatus.className = `status-dot ${isOnline ? 'online' : 'offline'}`;
            currentChatStatusText.textContent = isOnline ? '在线' : '离线';
            
            // 启用消息输入框和发送按钮
            messageInput.disabled = false;
            messageInput.placeholder = "输入消息...按Enter发送，Shift+Enter换行";
            sendBtn.disabled = false;
            
            // 启用功能按钮
            emojiBtn.disabled = false;
            videoCallBtn.disabled = false;
            voiceCallBtn.disabled = false;
            attachBtn.disabled = false;
            
            // 渲染消息
            renderMessages(userId);
            
            // 滚动到消息底部
            scrollToBottom();
        }
        
        // 渲染消息
        function renderMessages(userId) {
            messagesContainer.innerHTML = '';
            
            // 获取与指定用户的聊天记录
            const chatMessages = getMessagesWithUser(userId);
            
            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="no-contacts" style="padding: 2rem;">
                        <i class="fas fa-comment-alt"></i>
                        <h3>开始对话</h3>
                        <p>发送第一条消息开始聊天</p>
                    </div>
                `;
                return;
            }
            
            chatMessages.forEach(message => {
                const isSent = message.senderId === currentUser.id;
                const otherUser = isSent ? getUserById(message.receiverId) : getUserById(message.senderId);
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                
                messageElement.innerHTML = `
                    <div class="message-avatar" style="background-color: ${isSent ? currentUser.color : otherUser.color};">${isSent ? currentUser.avatar : otherUser.avatar}</div>
                    <div>
                        <div class="message-content">${message.text}</div>
                        <div class="message-time">${message.time}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
        }
        
        // 发送消息 - 无自动回复
        function sendMessage() {
            if (!currentChatUserId || !messageInput.value.trim()) return;
            
            const text = messageInput.value.trim();
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // 创建新消息
            const newMessage = {
                id: Date.now(),
                senderId: currentUser.id,
                receiverId: currentChatUserId,
                text: text,
                time: time,
                read: false
            };
            
            // 保存消息
            saveMessage(newMessage);
            
            // 清空输入框
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // 重新渲染消息
            renderMessages(currentChatUserId);
            
            // 滚动到底部
            scrollToBottom();
            
            // 更新聊天列表
            renderChatsList();
            
            // 显示发送成功通知
            showNotification('消息发送', '消息已发送');
        }
        
        // 发送好友请求
        function sendFriendRequest(toUserId) {
            // 检查是否已经发送过请求
            const existingRequest = friendRequestsDB.find(req => 
                req.fromUserId === currentUser.id && req.toUserId === toUserId && req.status === 'pending'
            );
            
            if (existingRequest) {
                showNotification('好友请求', '您已经发送过好友请求了');
                return;
            }
            
            // 创建新请求
            const newRequest = {
                id: friendRequestsDB.length > 0 ? Math.max(...friendRequestsDB.map(r => r.id)) + 1 : 1,
                fromUserId: currentUser.id,
                toUserId: toUserId,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            friendRequestsDB.push(newRequest);
            localStorage.setItem('chathub_friend_requests', JSON.stringify(friendRequestsDB));
            
            // 重新渲染添加好友列表
            renderAddFriendList();
            
            // 显示通知
            const user = getUserById(toUserId);
            showNotification('好友请求', `已向 ${user.username} 发送好友请求`);
        }
        
        // 接受好友请求
        function acceptFriendRequest(requestId) {
            const request = friendRequestsDB.find(req => req.id === requestId);
            if (!request) return;
            
            // 更新请求状态
            request.status = 'accepted';
            localStorage.setItem('chathub_friend_requests', JSON.stringify(friendRequestsDB));
            
            // 添加好友关系
            const newFriend1 = {
                userId: currentUser.id,
                friendId: request.fromUserId,
                status: 'accepted'
            };
            
            const newFriend2 = {
                userId: request.fromUserId,
                friendId: currentUser.id,
                status: 'accepted'
            };
            
            friendsDB.push(newFriend1);
            friendsDB.push(newFriend2);
            localStorage.setItem('chathub_friends', JSON.stringify(friendsDB));
            
            // 更新对方的在线状态（如果存在）
            if (!onlineStatus[request.fromUserId]) {
                onlineStatus[request.fromUserId] = false;
                localStorage.setItem('chathub_online_status', JSON.stringify(onlineStatus));
            }
            
            // 重新渲染
            renderFriendRequests();
            renderFriendsList();
            renderChatsList();
            renderAddFriendList();
            updateOnlineCount();
            
            // 显示通知
            const user = getUserById(request.fromUserId);
            showNotification('好友请求', `您已接受 ${user.username} 的好友请求`);
        }
        
        // 拒绝好友请求
        function rejectFriendRequest(requestId) {
            const request = friendRequestsDB.find(req => req.id === requestId);
            if (!request) return;
            
            // 更新请求状态
            request.status = 'rejected';
            localStorage.setItem('chathub_friend_requests', JSON.stringify(friendRequestsDB));
            
            // 重新渲染
            renderFriendRequests();
            
            // 显示通知
            const user = getUserById(request.fromUserId);
            showNotification('好友请求', `您已拒绝 ${user.username} 的好友请求`);
        }
        
        // 删除好友
        function removeFriend(friendId) {
            if (!confirm('确定要删除这位好友吗？')) return;
            
            // 从好友关系中移除
            friendsDB = friendsDB.filter(friend => 
                !(friend.userId === currentUser.id && friend.friendId === friendId) &&
                !(friend.userId === friendId && friend.friendId === currentUser.id)
            );
            
            localStorage.setItem('chathub_friends', JSON.stringify(friendsDB));
            
            // 如果当前正在与这位好友聊天，重置聊天界面
            if (currentChatUserId === friendId) {
                currentChatUserId = null;
                currentChatUser.textContent = '选择聊天';
                currentChatAvatar.textContent = '?';
                currentChatAvatar.style.backgroundColor = '#e9ecef';
                currentChatStatus.className = 'status-dot offline';
                currentChatStatusText.textContent = '离线';
                messageInput.disabled = true;
                messageInput.placeholder = "选择聊天后输入消息...按Enter发送，Shift+Enter换行";
                sendBtn.disabled = true;
                emojiBtn.disabled = true;
                videoCallBtn.disabled = true;
                voiceCallBtn.disabled = true;
                attachBtn.disabled = true;
                messagesContainer.innerHTML = `
                    <div class="no-contacts">
                        <i class="fas fa-comments"></i>
                        <h3>欢迎使用 ChatHub</h3>
                        <p>选择左侧的联系人开始聊天，或添加新好友</p>
                    </div>
                `;
            }
            
            // 重新渲染
            renderFriendsList();
            renderChatsList();
            renderAddFriendList();
            updateOnlineCount();
            
            // 显示通知
            const user = getUserById(friendId);
            showNotification('好友管理', `您已删除好友 ${user.username}`);
        }
        
        // 处理用户搜索
        function handleUserSearch() {
            const searchTerm = searchUsersInput.value.toLowerCase();
            
            document.querySelectorAll('.add-friend-item').forEach(item => {
                const username = item.querySelector('h4').textContent.toLowerCase();
                const email = item.querySelector('p').textContent.toLowerCase();
                
                if (username.includes(searchTerm) || email.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // 切换用户菜单显示
        function toggleUserDropdown() {
            userDropdown.classList.toggle('active');
        }
        
        // 处理退出登录
        function handleLogout() {
            // 更新用户离线状态
            if (currentUser) {
                onlineStatus[currentUser.id] = false;
                localStorage.setItem('chathub_online_status', JSON.stringify(onlineStatus));
            }
            
            currentUser = null;
            localStorage.removeItem('chathub_current_user');
            
            authContainer.style.display = 'flex';
            mainContainer.style.display = 'none';
            
            // 清空登录表单
            document.getElementById('login-form').reset();
            
            showNotification('退出登录', '您已成功退出登录');
        }
        
        // 显示通知
        function showNotification(title, text) {
            notificationTitle.textContent = title;
            notificationText.textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 滚动到消息底部
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 辅助函数
        function getUserById(id) {
            return usersDB.find(user => user.id === id);
        }
        
        function getFriends() {
            if (!currentUser) return [];
            return friendsDB.filter(friend => friend.userId === currentUser.id && friend.status === 'accepted');
        }
        
        function getMessagesWithUser(userId) {
            const key = `${Math.min(currentUser.id, userId)}-${Math.max(currentUser.id, userId)}`;
            return messagesDB[key] || [];
        }
        
        function getLastMessageWithUser(userId) {
            const messages = getMessagesWithUser(userId);
            return messages.length > 0 ? messages[messages.length - 1] : null;
        }
        
        function saveMessage(message) {
            const key = `${Math.min(message.senderId, message.receiverId)}-${Math.max(message.senderId, message.receiverId)}`;
            
            if (!messagesDB[key]) {
                messagesDB[key] = [];
            }
            
            messagesDB[key].push(message);
            localStorage.setItem('chathub_messages', JSON.stringify(messagesDB));
        }
        
        function getRandomColor() {
            const colors = ['#ffd166', '#ef476f', '#06d6a0', '#118ab2', '#073b4c', '#7209b7', '#f72585'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>